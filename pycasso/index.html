<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Pycasso</title>
  </head>
  <body>
    <canvas width="150" height="150" style="border: 2px solid red"></canvas>

    <script>
      var ws = new WebSocket("ws://localhost:3001");
      ws.onopen = function () {
        console.log("Connected to server");
      };
      ws.onmessage = function (event) {
        // console.log("Message received: " + event.data);
        // Parse the incoming message
        LATEST_MESSAGE = event.data;
        MESSAGE_ID++;

        // Immediately draw the latest message for messages that edit the page
        if (LATEST_MESSAGE.startsWith("resize")) {
          parseAndDraw(LATEST_MESSAGE);
        }
      };
      ws.onclose = function () {
        console.log("Disconnected from server");
      };
    </script>

    <script>
      const canvas = document.querySelector("canvas");
      const ctx = canvas.getContext("2d");

      let LATEST_MESSAGE = "";
      let MESSAGE_ID = 0;
      let LATEST_MESSAGE_ID = -1;
      animate();

      function animate() {
        if (LATEST_MESSAGE_ID !== MESSAGE_ID) {
          parseAndDraw(LATEST_MESSAGE);
        }

        requestAnimationFrame(animate);
      }

      function parseMessage(message) {
        return message.split("\n").map((command) => {
          // Find the index of the first occurrence of ":"
          var separatorIndex = command.indexOf(":");
          if (separatorIndex === -1) {
            console.log("Invalid command format", command);
            return; // Skip this command if the format is invalid
          }

          // Extract the function name and arguments based on the index
          var functionName = command.substring(0, separatorIndex);
          var args = command.substring(separatorIndex + 1).split(";");

          return { functionName, args };
        });
      }

      function parseAndDraw(msg) {
        if (msg === "") return;

        var commands = parseMessage(msg);

        commands.forEach(function ({ functionName, args }) {
          executeCanvasCommand(functionName, args);
        });
      }

      function executeCanvasCommand(functionName, args) {
        switch (functionName) {
          case "resize":
            canvas.setAttribute("width", args[0]);
            canvas.setAttribute("height", args[1]);

            canvas.style.width = args[0];
            canvas.style.height = args[1];
            break;
          case "clear":
            ctx.clearRect(...args.map(Number));
            break;
          case "fillStyle":
            ctx.fillStyle = args.join("");
            break;
          case "fillRect":
            ctx.fillRect(...args.map(Number));
            break;
          default:
            console.log("Unknown command: " + functionName);
        }
      }
    </script>
  </body>
</html>
